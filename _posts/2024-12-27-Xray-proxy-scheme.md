---
layout: post
title: "Многоуровневая прокси-схема с использованием Xray"
---
Идея предполагает создание цепочки прокси-серверов, где один из них находится в вашей стране, а другой - за рубежом. Это вполне реализуемо, и подобная схема действительно может скрыть использование зарубежного прокси, так как для наблюдателя ваш трафик будет выглядеть как соединение с локальным сервером.

## Введение

Многоуровневая прокси-схема позволяет использовать несколько прокси-серверов для скрытия маршрута и защиты данных, проходящих через интернет. В этой статье мы рассмотрим, как настроить такую схему с помощью **Xray** - мощного инструмента для обхода блокировок и шифрования трафика.

## Зачем это нужно?

Предположим, вы хотите скрыть использование зарубежных сервисов и обойти сетевые блокировки. Для этого можно настроить два прокси-сервера:
1. **Локальный прокси** - будет принимать и отправлять запросы внутри вашей страны (например, к локальным сайтам и IP-адресам).
2. **Зарубежный прокси** - будет использоваться для доступа к интернет-ресурсам, находящимся за пределами вашей страны.

Эта схема скрывает реальные места подключения, так что ваше соединение будет казаться нормальным запросом на локальный сервер.

Необходимо арендовать два **VPS**, один в России, другой - за рубежом. Тематику выбора провайдеров затрагивать не будем.

## Шаги настройки
### 1. Установка Xray

Сначала установите **Xray** на ваши серверы, используя официальное руководство:

```bash
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"
```

### 2. Настройка локального прокси

**Xray** поддерживает настройку правил маршрутизации трафика с помощью модуля `routing`. Вы можете настроить его так, чтобы локальный трафик (например, трафик к локальным IP-адресам или доменам) обрабатывался напрямую, а весь остальной трафик перенаправлялся через зарубежный прокси. В конфигурационном файле **Xray** на локальном сервере используем Shadowsocks для подключения к серверу за рубежом `/usr/local/etc/xray/config.json`:

```json
{
  "inbounds": [
    {
      "port": 1080,
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct",
      "settings": {}
    },
    {
      "protocol": "shadowsocks",
      "tag": "proxy",
      "settings": {
        "servers": [
          {
            "address": "IP_заграничного_сервера",
            "port": 8388,
            "method": "aes-256-gcm",
            "password": "your_password"
          }
        ]
      }
    }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "domain": [
          "geosite:category-ru",
          "domain:localhost"
        ],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "ip": [
          "geoip:private"
        ],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "ip": [
          "0.0.0.0/0"
        ],
        "outboundTag": "proxy"
      }
    ]
  }
}
```
Здесь мы настроили SOCKS-прокси на порту 1080, который будет использоваться вашим устройством для подключения. Подключение к локальному прокси осуществляется по протоколу **SOCKS**, не шифруется. Это обеспечивает прекрасную скорость работы.

### 3. Настройка зарубежного прокси

Теперь настроим зарубежный прокси-сервер, который будет отправлять запросы в интернет, файл `/usr/local/etc/xray/config.json`:

```json
{
  "inbounds": [
    {
      "port": 8388,
      "protocol": "shadowsocks",
      "settings": {
        "method": "aes-256-gcm",
        "password": "your_password",
        "network": "tcp,udp"
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {}
    }
  ]
}
```

### 4. Обновление файлов `geoip.dat` и `geosite.dat` с помощью официального скрипта

Для точной маршрутизации трафика по географическим регионам Xray использует файлы `geoip.dat` и `geosite.dat`. Эти файлы содержат информацию о странах и доменах, и их необходимо регулярно обновлять. Это можно сделать с помощью официального скрипта **Xray**:

```bash
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install-geodata
```

### 5. Автоматизация обновлений

Если вы хотите, чтобы обновления файлов `geoip.dat` и `geosite.dat` происходили автоматически, можно настроить cron-задачу:

```bash
crontab -e
```

Добавьте строку для выполнения обновления раз в день (например, в 3:00 ночи):

```bash
0 3 * * * bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install-geodata && systemctl restart xray
```

Сохраните изменения и выйдите из редактора. Этот скрипт автоматически скачает актуальные версии файлов и обновит их, а также перезапустит **Xray**, чтобы новые настройки вступили в силу.

## Заключение

Теперь у вас настроена многоуровневая прокси-система, которая обеспечивает шифрование трафика и скрывает использование зарубежных сервисов. Локальный прокси принимает запросы, а зарубежный сервер отправляет их в интернет. Это решение подходит для обеспечения анонимности и обхода сетевых блокировок. В моём случае прекрасно работают ресурсы **Google Gemini**, **ChatGPT**, **Microsoft Copilot** и т.д.